<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Analytical Feedback | GradSystem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
    .heatmap-zone { 
        border-bottom: 2px dashed rgba(0,0,0,0.15); 
        position: absolute; width: 100%; height: 33.33%; 
        display: flex; align-items: center; justify-content: center; 
        opacity: 0.35; /* Handwriting is now visible */
    }
    .density-pill { 
        color: #000000 !important; /* Forces black text */
        background: rgba(255,255,255,0.7); 
        padding: 6px 16px; border-radius: 99px; font-weight: 800; 
        font-size: 0.75rem; backdrop-filter: blur(8px);
    }
</style>
</head>
<body>
    <nav class="bg-white border-b px-10 py-5 flex justify-between items-center sticky top-0 z-50">
        <h1 class="text-xl font-bold text-blue-600">GradSystem <span class="text-slate-300">| Result Analysis</span></h1>
        <button onclick="window.location.href='student.html'" class="text-xs font-bold text-slate-400 hover:text-blue-600">Back to Dashboard</button>
    </nav>

    <main class="max-w-[1600px] mx-auto p-10 grid grid-cols-1 lg:grid-cols-12 gap-10">
        <div class="lg:col-span-4 bg-white p-6 rounded-[3rem] shadow-xl border border-slate-100 h-fit">
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6 px-2">Density Diagnostic</h3>
            <div class="relative rounded-[2.5rem] overflow-hidden bg-slate-50 border shadow-inner">
                <img id="studentImg" src="" class="w-full">
                <div id="h-top" class="heatmap-zone top-0"><span class="density-pill" id="t-text">--%</span></div>
                <div id="h-mid" class="heatmap-zone top-1/3"><span class="density-pill" id="m-text">--%</span></div>
                <div id="h-bot" class="heatmap-zone top-2/3"><span class="density-pill" id="b-text">--%</span></div>
            </div>
        </div>

        <div class="lg:col-span-8 space-y-8">
            <div class="bg-white p-10 rounded-[3rem] shadow-xl border border-slate-100 flex justify-between items-center">
                <div><p class="text-[10px] font-black text-blue-500 uppercase">AI Grade</p><h2 class="text-8xl font-black text-slate-800" id="score">--</h2></div>
                <div id="stars" class="text-3xl text-yellow-400"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-8 rounded-[2.5rem] shadow-lg border border-slate-100">
                    <h3 class="text-sm font-bold text-slate-800 mb-6">Strategic Performance</h3>
                    <div style="height: 350px;"><canvas id="radarChart"></canvas></div>
                </div>
                <div class="bg-white p-8 rounded-[2.5rem] shadow-lg border border-slate-100">
                    <h3 class="text-sm font-bold text-slate-800 mb-6">Criteria Mastery</h3>
                    <div style="height: 350px;"><canvas id="barChart"></canvas></div>
                </div>
            </div>

            <div class="bg-blue-600 p-8 rounded-3xl text-white shadow-lg">
                <h4 class="text-[10px] font-black uppercase opacity-80 mb-3">ðŸ¤– AI Tutor Recommendation</h4>
                <p id="feedback" class="text-sm font-bold leading-relaxed"></p>
            </div>
        </div>
    </main>

    <script src="config.js"></script>
    <script>
        const subId = new URLSearchParams(window.location.search).get('id');
        let radarChart, barChart;

        function initCharts() {
            const labels = ['Concept', 'Clarity', 'Argument', 'Evidence', 'Relevance'];
            radarChart = new Chart(document.getElementById('radarChart'), {
                type: 'radar',
                data: { labels, datasets: [{ backgroundColor: 'rgba(236, 72, 153, 0.2)', borderColor: '#ec4899', borderWidth: 3, data: [0,0,0,0,0] }] },
                options: { scales: { r: { suggestedMin: 0, suggestedMax: 100, ticks: { display: false }, pointLabels: { font: { weight: '600' } } } }, plugins: { legend: { display: false } } }
            });
            barChart = new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: { labels, datasets: [{ backgroundColor: '#4f46e5', data: [0,0,0,0,0], borderRadius: 12 }] },
                options: { indexAxis: 'y', scales: { x: { beginAtZero: true, max: 100, grid: { display: false } } }, plugins: { legend: { display: false } } }
            });
        }

        db.collection('submissions').doc(subId).onSnapshot(doc => {
            if (!doc.exists) return;
            const d = doc.data(), ai = d.ai_full_json || {}, s = ai.scores || {};
            document.getElementById('studentImg').src = d.image_url;
            document.getElementById('score').innerText = d.ai_score || "--";
            document.getElementById('stars').innerText = "â˜…".repeat(d.stars || 0);
            document.getElementById('feedback').innerText = d.ai_feedback || "Analysis in progress...";

            // Map and animate rubrics
            const chartData = [s.concept || 0, s.clarity || 0, s.argumentation || 0, s.evidence || 0, s.relevance || 0];
            radarChart.data.datasets[0].data = chartData;
            barChart.data.datasets[0].data = chartData;
            radarChart.update(); barChart.update();

            const render = (id, txt, val) => {
                const el = document.getElementById(id), t = document.getElementById(txt), n = parseInt(val) || 0;
                el.style.backgroundColor = n >= 8 ? '#22c55e' : (n >= 4 ? '#eab308' : '#ef4444');
                t.innerText = `${n*10}% Density`;
            };
            render('h-top', 't-text', ai.heatmap?.top); render('h-mid', 'm-text', ai.heatmap?.middle); render('h-bot', 'b-text', ai.heatmap?.bottom);
        });

        window.onload = initCharts;
    </script>
</body>
</html>