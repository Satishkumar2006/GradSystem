<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Dashboard | GradSystem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
</head>
<body class="bg-[#F8FAFC] min-h-screen">
    <nav class="bg-white px-10 py-5 flex justify-between items-center border-b border-slate-100 sticky top-0 z-50">
        <div class="flex items-center gap-6">
            <h1 class="text-xl font-bold text-blue-600">GradSystem</h1>
            <p class="text-sm font-bold text-slate-600">Welcome back, <span id="studentNameDisplay" class="text-blue-600">--</span></p>
        </div>
        <button onclick="auth.signOut(); window.location.href='index.html';" class="text-xs font-bold text-slate-400 hover:text-red-500">Logout</button>
    </nav>

    <main class="max-w-[1600px] mx-auto p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-3 space-y-6">
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-2">Your History</h3>
            <div id="historyList" class="space-y-3"></div>
        </div>

        <div class="lg:col-span-5 space-y-6">
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-2">Available Tasks</h3>
            <div id="taskList" class="space-y-4"></div>
        </div>

        <div class="lg:col-span-4">
            <div class="bg-white rounded-[2.5rem] p-10 shadow-xl border border-slate-100">
                <h3 class="text-xl font-black mb-10">Class Rankings</h3>
                <div class="flex justify-center items-end gap-4 mb-12 h-32">
                    <div class="text-center"><span id="p2" class="text-[10px] font-bold text-slate-400 mb-2 block truncate w-16 mx-auto">--</span><div class="w-14 h-16 bg-slate-50 rounded-t-2xl border flex items-center justify-center font-black">2</div></div>
                    <div class="text-center"><span id="p1" class="text-[10px] font-black text-yellow-600 mb-2 uppercase block truncate w-20 mx-auto">--</span><div class="w-16 h-24 bg-yellow-50 rounded-t-2xl border border-yellow-200 flex items-center justify-center font-black text-yellow-500 text-2xl shadow-lg">1</div></div>
                    <div class="text-center"><span id="p3" class="text-[10px] font-bold text-slate-400 mb-2 block truncate w-14 mx-auto">--</span><div class="w-14 h-12 bg-slate-50 rounded-t-2xl border flex items-center justify-center font-black">3</div></div>
                </div>
                <div id="rankList" class="divide-y divide-slate-50"></div>
            </div>
        </div>
    </main>

    <div id="uploadModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-[2.5rem] p-10 w-full max-w-md shadow-2xl">
            <h3 class="text-2xl font-black text-slate-800 mb-6">Submit Work</h3>
            <div class="space-y-5">
                <select id="taskSelect" class="w-full p-4 border rounded-2xl bg-slate-50 text-sm font-bold"></select>
                <input type="file" id="workImg" accept="image/*" class="text-xs text-slate-500">
                <button id="uploadBtn" onclick="handleUpload()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black">UPLOAD & GRADE</button>
                <button onclick="document.getElementById('uploadModal').classList.add('hidden')" class="w-full text-slate-400 font-bold text-xs py-2">Cancel</button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let studentMap = {}, gradedSubs = [], assignments = [];
        auth.onAuthStateChanged(async user => {
            if (!user) return window.location.href = 'index.html';
            const uSnap = await db.collection('users').get();
            uSnap.forEach(u => studentMap[u.id] = u.data().name || "Student");
            document.getElementById('studentNameDisplay').innerText = studentMap[user.uid];
            loadData(user.uid);
        });

        async function loadData(uid) {
            db.collection('assignments').onSnapshot(snap => {
                const list = document.getElementById('taskList'), select = document.getElementById('taskSelect');
                list.innerHTML = ''; select.innerHTML = ''; assignments = [];
                snap.forEach(doc => {
                    const t = doc.data(); assignments.push({id: doc.id, ...t});
                    list.innerHTML += `<div class="bg-white p-6 rounded-3xl border border-slate-100 flex justify-between items-center shadow-sm">
                        <div><h4 class="font-bold text-slate-800">${t.title}</h4></div>
                        <div class="flex gap-3">
                            ${t.reference_url ? `<a href="${t.reference_url}" target="_blank" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-xs font-black">QUESTIONS</a>` : ''}
                            <button onclick="openUpload('${doc.id}')" class="bg-slate-900 text-white px-4 py-2 rounded-xl text-xs font-black">SUBMIT</button>
                        </div>
                    </div>`;
                    select.innerHTML += `<option value="${doc.id}">${t.title}</option>`;
                });
                loadHistory(uid);
            });

            db.collection('submissions').where('status', '==', 'graded_by_ai').onSnapshot(snap => {
                gradedSubs = snap.docs.map(d => ({id: d.id, ...d.data()})); renderRankings();
            });
        }

        function loadHistory(uid) {
            db.collection('submissions').where('student_id', '==', uid).onSnapshot(snap => {
                const list = document.getElementById('historyList'); list.innerHTML = '';
                const sorted = snap.docs.sort((a,b) => b.data().created_at?.toMillis() - a.data().created_at?.toMillis());
                sorted.forEach(doc => {
                    const s = doc.data(), subject = assignments.find(a => a.id === s.assignment_id)?.title || "Subject";
                    list.innerHTML += `<div onclick="window.location.href='results.html?id=${doc.id}'" class="bg-white p-5 rounded-2xl border flex justify-between items-center cursor-pointer hover:border-blue-500">
                        <span class="font-bold text-slate-700 text-sm truncate">${subject}</span>
                        <span class="px-2 py-1 bg-blue-50 text-blue-600 rounded text-xs font-black">${s.ai_score || '--'}/10</span>
                    </div>`;
                });
            });
        }

        function openUpload(id) { document.getElementById('taskSelect').value = id; document.getElementById('uploadModal').classList.remove('hidden'); }

        function renderRankings() {
            let matrix = {};
            gradedSubs.forEach(s => {
                const sid = s.student_id, time = s.created_at?.toMillis() || 0;
                if (!matrix[sid]) matrix[sid] = {};
                if (!matrix[sid][s.assignment_id] || time > matrix[sid][s.assignment_id].time) matrix[sid][s.assignment_id] = { score: s.ai_score, time: time };
            });

            let ranks = Object.keys(matrix).map(sid => ({ name: studentMap[sid], score: Object.values(matrix[sid]).reduce((a,c) => a+c.score, 0) / Object.values(matrix[sid]).length })).sort((a,b) => b.score - a.score);
            document.getElementById('p1').innerText = ranks[0]?.name.split(' ')[0] || '--';
            document.getElementById('p2').innerText = ranks[1]?.name.split(' ')[0] || '--';
            document.getElementById('p3').innerText = ranks[2]?.name.split(' ')[0] || '--';
            document.getElementById('rankList').innerHTML = ranks.map((s, i) => `<div class="flex items-center justify-between py-4 ${i < 3 ? 'bg-blue-50/20 px-4 rounded-xl' : ''}"><span class="font-bold text-slate-700 text-xs">${s.name}</span><span class="font-black text-slate-800 text-xs">${s.score.toFixed(1)}</span></div>`).join('');
        }

        async function handleUpload() {
            const btn = document.getElementById('uploadBtn'), file = document.getElementById('workImg').files[0], taskId = document.getElementById('taskSelect').value;
            if(!file) return alert("Select image!");
            btn.disabled = true; btn.innerText = "Processing...";
            try {
                const ref = storage.ref(`submissions/${Date.now()}_${file.name}`);
                await ref.put(file);
                await db.collection('submissions').add({ assignment_id: taskId, image_url: await ref.getDownloadURL(), student_id: auth.currentUser.uid, status: 'pending', created_at: firebase.firestore.FieldValue.serverTimestamp() });
                document.getElementById('uploadModal').classList.add('hidden'); btn.disabled = false;
            } catch (err) { alert("Fail"); btn.disabled = false; }
        }
    </script>
</body>
</html>